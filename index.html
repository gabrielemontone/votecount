<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoteCount by GetElected</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #4a90e2 100%);
            min-height: 100vh;
            color: white;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .header h1 {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-shadow: 0 1px 5px rgba(255, 255, 255, 0.1);
            font-family: 'Archivo', sans-serif;
        }
        
        .header h1 .vote-part {
            background: linear-gradient(45deg, #ffffff, #e8f4fd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }
        
        .header h1 .count-part {
            background: linear-gradient(45deg, #ffffff, #e8f4fd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }
        
        .header h1 .by-part {
            background: linear-gradient(45deg, #ffffff, #e8f4fd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: normal;
        }
        
        .header h1 .getelected-part {
            font-weight: 700;
            font-family: 'Archivo', sans-serif;
        }
        
        .header h1 .get-part {
            background: linear-gradient(45deg, #b0b0b0, #cccccc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header h1 .elected-part {
            background: linear-gradient(45deg, #1470af, #2196f3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .firebase-setup {
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 2rem 0;
            text-align: center;
        }
        
        .firebase-setup h3 {
            color: #ffd700;
            margin-bottom: 1rem;
        }
        
        .firebase-setup p {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .firebase-config {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.8rem;
            text-align: left;
            overflow-x: auto;
        }
        
        .btn {
            background: linear-gradient(45deg, #2196f3, #1976d2);
            border: none;
            padding: 1rem 2rem;
            margin: 0.5rem;
            border-radius: 50px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px rgba(33, 150, 243, 0.4);
            min-width: 120px;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(33, 150, 243, 0.6);
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn.secondary {
            background: linear-gradient(45deg, #607d8b, #455a64);
            box-shadow: 0 10px 25px rgba(96, 125, 139, 0.4);
        }
        
        .btn.secondary:hover {
            box-shadow: 0 15px 35px rgba(96, 125, 139, 0.6);
        }
        
        .btn.success {
            background: linear-gradient(45deg, #4caf50, #388e3c);
            box-shadow: 0 10px 25px rgba(76, 175, 80, 0.4);
        }
        
        .btn.success:hover {
            box-shadow: 0 15px 35px rgba(76, 175, 80, 0.6);
        }
        
        .btn.danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            box-shadow: 0 10px 25px rgba(244, 67, 54, 0.4);
        }
        
        .btn.danger:hover {
            box-shadow: 0 15px 35px rgba(244, 67, 54, 0.6);
        }
        
        .form-group {
            margin: 1.5rem 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #e8f4fd;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 1);
        }
        
        .session-code {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            margin: 1.5rem 0;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            letter-spacing: 0.3em;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .party-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }
        
        .party-btn {
            padding: 1.5rem;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 15px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .party-btn.conservative { background: linear-gradient(45deg, #0087dc, #005ba1); }
        .party-btn.labour { background: linear-gradient(45deg, #e4003b, #b8002e); }
        .party-btn.reform { background: linear-gradient(45deg, #12b2b5, #0e9094); }
        .party-btn.libdem { background: linear-gradient(45deg, #faa61a, #e8941a); }
        
        .party-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }
        
        .party-btn:active {
            transform: scale(0.98);
        }
        
        .party-btn .count {
            position: absolute;
            top: 10px;
            right: 15px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .participants-section {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 2rem 0;
        }
        
        .participant-request {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
            margin: 0.5rem 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .participant-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .data-summary {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 2rem 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .box-summary {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .box-summary h4 {
            color: #b3d9ff;
            margin-bottom: 0.5rem;
        }
        
        .vote-tally {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .tally-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem;
            border-radius: 5px;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .hidden {
            display: none;
        }
        
        .back-btn {
            background: linear-gradient(45deg, #607d8b, #455a64);
            border: none;
            color: white;
            padding: 0.7rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-connected { background: #4caf50; }
        .status-pending { background: #ff9800; }
        .status-disconnected { background: #f44336; }
        
        .current-box-info {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }
        
        .button-config {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .button-config-item {
            display: flex;
            align-items: center;
            margin: 0.5rem 0;
            gap: 1rem;
        }
        
        .button-config-item select {
            flex: 1;
        }
        
        .button-config-item input {
            flex: 2;
        }
        
        .connection-status {
            text-align: center;
            margin: 1rem 0;
            padding: 0.5rem;
            border-radius: 10px;
            font-size: 0.9rem;
        }
        
        .connection-status.connected {
            background: rgba(76, 175, 80, 0.2);
            color: #a5d6a7;
        }
        
        .connection-status.disconnected {
            background: rgba(244, 67, 54, 0.2);
            color: #ef9a9a;
        }
        
        .connection-status.connecting {
            background: rgba(255, 152, 0, 0.2);
            color: #ffcc02;
        }
        
        .footer {
            text-align: center;
            margin-top: 2rem;
            padding: 1rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 1rem;
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .party-buttons {
                grid-template-columns: 1fr;
            }
            
            .session-code {
                font-size: 2rem;
            }
            
            .button-config-item {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Firebase Setup Notice -->
    <div id="firebaseSetup" class="container">
        <div class="header">
            <h1><span class="vote-part">Vote</span><span class="count-part">Count</span> <span class="by-part">by</span> <span class="getelected-part"><span class="get-part">Get</span><span class="elected-part">Elected</span></span></h1>
        </div>
        
        <div class="firebase-setup">
            <h3>🔧 Firebase Setup Required</h3>
            <p>To use this app across devices, you need to set up Firebase first:</p>
            <p>1. Go to <strong>console.firebase.google.com</strong></p>
            <p>2. Create a new project (free)</p>
            <p>3. Enable Realtime Database</p>
            <p>4. Set security rules to: <code>{ "rules": { ".read": true, ".write": true } }</code></p>
            <p>5. Copy your config and replace the placeholder below:</p>
            
            <div class="firebase-config">
// Replace this placeholder config with your Firebase config:<br>
const firebaseConfig = {<br>
&nbsp;&nbsp;apiKey: "your-api-key",<br>
&nbsp;&nbsp;authDomain: "your-project.firebaseapp.com",<br>
&nbsp;&nbsp;databaseURL: "https://your-project-default-rtdb.firebaseio.com/",<br>
&nbsp;&nbsp;projectId: "your-project",<br>
&nbsp;&nbsp;storageBucket: "your-project.appspot.com",<br>
&nbsp;&nbsp;messagingSenderId: "123456789",<br>
&nbsp;&nbsp;appId: "your-app-id"<br>
};
            </div>
            
            <button class="btn success" onclick="initializeFirebase()">I've Updated the Config - Initialize App</button>
        </div>
        
        <div class="footer">
            © 2025 GETELECTED LTD. All rights reserved.
        </div>
    </div>
    
    <!-- Home Screen -->
    <div id="homeScreen" class="container hidden">
        <div class="header">
            <h1><span class="vote-part">Vote</span><span class="count-part">Count</span> <span class="by-part">by</span> <span class="getelected-part"><span class="get-part">Get</span><span class="elected-part">Elected</span></span></h1>
        </div>
        
        <div class="connection-status" id="connectionStatus">
            <div class="status-indicator status-connecting"></div>
            Connecting...
        </div>
        
        <div style="text-align: center;">
            <button class="btn" onclick="showCreateSession()">Create New Count</button>
            <button class="btn secondary" onclick="showJoinSession()">Join Count</button>
        </div>
        
        <div class="footer">
            © 2025 GETELECTED LTD. All rights reserved.
        </div>
    </div>
    
    <!-- Create Session Screen -->
    <div id="createSessionScreen" class="container hidden">
        <div class="header">
            <h1><span class="vote-part">Vote</span><span class="count-part">Count</span> <span class="by-part">by</span> <span class="getelected-part"><span class="get-part">Get</span><span class="elected-part">Elected</span></span></h1>
        </div>
        
        <button class="back-btn" onclick="goHome()">← Back to Home</button>
        
        <h2>Create New Count Session</h2>
        
        <div class="button-config">
            <h3>Configure Party Buttons</h3>
            <p>Set the order and labels for the voting buttons:</p>
            
            <div class="button-config-item">
                <select id="button1Select">
                    <option value="conservative">Conservative</option>
                    <option value="labour">Labour</option>
                    <option value="reform">Reform</option>
                    <option value="libdem">LibDem</option>
                </select>
                <input type="text" id="button1Note" placeholder="Additional note (optional)">
            </div>
            
            <div class="button-config-item">
                <select id="button2Select">
                    <option value="labour" selected>Labour</option>
                    <option value="conservative">Conservative</option>
                    <option value="reform">Reform</option>
                    <option value="libdem">LibDem</option>
                </select>
                <input type="text" id="button2Note" placeholder="Additional note (optional)">
            </div>
            
            <div class="button-config-item">
                <select id="button3Select">
                    <option value="reform" selected>Reform</option>
                    <option value="conservative">Conservative</option>
                    <option value="labour">Labour</option>
                    <option value="libdem">LibDem</option>
                </select>
                <input type="text" id="button3Note" placeholder="Additional note (optional)">
            </div>
            
            <div class="button-config-item">
                <select id="button4Select">
                    <option value="libdem" selected>LibDem</option>
                    <option value="conservative">Conservative</option>
                    <option value="labour">Labour</option>
                    <option value="reform">Reform</option>
                </select>
                <input type="text" id="button4Note" placeholder="Additional note (optional)">
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 2rem;">
            <button class="btn success" onclick="createSession()">Create Session</button>
        </div>
        
        <div class="footer">
            © 2025 GETELECTED LTD. All rights reserved.
        </div>
    </div>
    
    <!-- Join Session Screen -->
    <div id="joinSessionScreen" class="container hidden">
        <div class="header">
            <h1><span class="vote-part">Vote</span><span class="count-part">Count</span> <span class="by-part">by</span> <span class="getelected-part"><span class="get-part">Get</span><span class="elected-part">Elected</span></span></h1>
        </div>
        
        <button class="back-btn" onclick="goHome()">← Back to Home</button>
        
        <h2>Join Count Session</h2>
        
        <div class="form-group">
            <label for="sessionCode">Session Code:</label>
            <input type="text" id="sessionCode" placeholder="Enter 6-digit code" maxlength="6">
        </div>
        
        <div class="form-group">
            <label for="participantName">Your Name:</label>
            <input type="text" id="participantName" placeholder="Enter your name">
        </div>
        
        <div style="text-align: center;">
            <button class="btn" onclick="requestJoinSession()">Request to Join</button>
        </div>
        
        <div id="waitingMessage" class="hidden" style="text-align: center; margin-top: 2rem;">
            <div class="status-indicator status-pending"></div>
            Waiting for host approval...
        </div>
        
        <div class="footer">
            © 2025 GETELECTED LTD. All rights reserved.
        </div>
    </div>
    
    <!-- Host Screen -->
    <div id="hostScreen" class="container hidden">
        <div class="header">
            <h1><span class="vote-part">Vote</span><span class="count-part">Count</span> <span class="by-part">by</span> <span class="getelected-part"><span class="get-part">Get</span><span class="elected-part">Elected</span></span></h1>
        </div>
        
        <button class="back-btn" onclick="endSession()">End Session</button>
        
        <h2>Count Session</h2>
        <div class="session-code" id="hostSessionCode"></div>
        <p style="text-align: center;">Share this code with participants</p>
        
        <div class="participants-section">
            <h3>Join Requests</h3>
            <div id="joinRequestsList"></div>
            
            <h3>Active Participants (<span id="participantCount">0</span>)</h3>
            <div id="participantsList" class="participant-list"></div>
        </div>
        
        <div class="data-summary">
            <h3>Live Vote Data</h3>
            <div id="liveData"></div>
        </div>
        
        <div style="text-align: center; margin-top: 2rem;">
            <button class="btn success" onclick="downloadData()">📊 Download All Data (CSV)</button>
        </div>
        
        <div class="footer">
            © 2025 GETELECTED LTD. All rights reserved.
        </div>
    </div>
    
    <!-- Participant Screen -->
    <div id="participantScreen" class="container hidden">
        <div class="header">
            <h1><span class="vote-part">Vote</span><span class="count-part">Count</span> <span class="by-part">by</span> <span class="getelected-part">GetElected</span></h1>
        </div>
        
        <button class="back-btn" onclick="leaveSession()">← Leave Session</button>
        
        <h2>Session: <span id="participantSessionCode"></span></h2>
        <p>Welcome, <span id="participantNameDisplay"></span>!</p>
        
        <div class="current-box-info">
            <h3>Current Box: <span id="currentBoxDisplay">Not Set</span></h3>
            <p>Ward: <span id="currentWardDisplay">Not Set</span></p>
        </div>
        
        <div class="form-group">
            <label for="boxNumber">Box Number (Required):</label>
            <input type="text" id="boxNumber" placeholder="Enter box number" required>
        </div>
        
        <div class="form-group">
            <label for="ward">Ward (Optional):</label>
            <input type="text" id="ward" placeholder="Enter ward">
        </div>
        
        <div style="text-align: center; margin: 1rem 0;">
            <button class="btn" onclick="setCurrentBox()">Set Current Box</button>
        </div>
        
        <div class="party-buttons" id="partyButtons">
            <!-- Buttons will be dynamically generated based on host configuration -->
        </div>
        
        <div style="text-align: center; margin-top: 2rem;">
            <button class="btn secondary" onclick="nextBox()">Next Box</button>
        </div>
        
        <div class="footer">
            © 2025 GETELECTED LTD. All rights reserved.
        </div>
    </div>

    <script>
        // Firebase configuration - REPLACE THIS WITH YOUR CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBKGuvK-ouf7-AjsOt4B7-p-lPMht7qEqo",
            authDomain: "votecount-1.firebaseapp.com",
            databaseURL: "https://votecount-1-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "votecount-1",
            storageBucket: "votecount-1.firebasestorage.app",
            messagingSenderId: "99846931133",
            appId: "1:99846931133:web:d6eb680cd32bebb04cadd4"
        };
        
        // Global variables
        let database = null;
        let isFirebaseInitialized = false;
        let currentSessionCode = null;
        let currentUserRole = null;
        let currentParticipantName = null;
        let currentParticipantId = null;
        let currentBox = null;
        let currentWard = null;
        let sessionConfig = null;
        let sessionListeners = {};
        
        function initializeFirebase() {
            try {
                // Check if the config has been updated
                if (firebaseConfig.apiKey === "placeholder-api-key") {
                    alert("Please update the Firebase configuration in the code first!");
                    return;
                }
                
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                isFirebaseInitialized = true;
                
                // Show home screen
                document.getElementById('firebaseSetup').classList.add('hidden');
                document.getElementById('homeScreen').classList.remove('hidden');
                
                updateConnectionStatus('connected');
                
                // Test connection
                database.ref('.info/connected').on('value', (snapshot) => {
                    if (snapshot.val() === true) {
                        updateConnectionStatus('connected');
                    } else {
                        updateConnectionStatus('disconnected');
                    }
                });
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                alert('Firebase initialization failed. Please check your configuration.');
                updateConnectionStatus('disconnected');
            }
        }
        
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            if (!statusElement) return;
            
            statusElement.className = `connection-status ${status}`;
            
            switch (status) {
                case 'connected':
                    statusElement.innerHTML = '<div class="status-indicator status-connected"></div>Online';
                    break;
                case 'disconnected':
                    statusElement.innerHTML = '<div class="status-indicator status-disconnected"></div>Offline';
                    break;
                case 'connecting':
                    statusElement.innerHTML = '<div class="status-indicator status-connecting"></div>Connecting...';
                    break;
            }
        }
        
        function generateSessionCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }
        
        function showCreateSession() {
            if (!isFirebaseInitialized) {
                alert('Please initialize Firebase first');
                return;
            }
            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('createSessionScreen').classList.remove('hidden');
        }
        
        function showJoinSession() {
            if (!isFirebaseInitialized) {
                alert('Please initialize Firebase first');
                return;
            }
            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('joinSessionScreen').classList.remove('hidden');
        }
        
        function createSession() {
            const code = generateSessionCode();
            
            // Get button configuration
            const buttonConfig = [];
            for (let i = 1; i <= 4; i++) {
                const party = document.getElementById(`button${i}Select`).value;
                const note = document.getElementById(`button${i}Note`).value.trim();
                buttonConfig.push({
                    party: party,
                    note: note,
                    label: party.charAt(0).toUpperCase() + party.slice(1) + (note ? ` (${note})` : '')
                });
            }
            
            const session = {
                code: code,
                host: true,
                buttonConfig: buttonConfig,
                participants: {},
                joinRequests: {},
                voteData: {},
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                lastActivity: firebase.database.ServerValue.TIMESTAMP
            };
            
            // Save to Firebase
            database.ref(`sessions/${code}`).set(session).then(() => {
                currentSessionCode = code;
                currentUserRole = 'host';
                sessionConfig = buttonConfig;
                
                showHostScreen();
            }).catch((error) => {
                console.error('Error creating session:', error);
                alert('Failed to create session. Please try again.');
            });
        }
        
        function showHostScreen() {
            document.getElementById('createSessionScreen').classList.add('hidden');
            document.getElementById('hostScreen').classList.remove('hidden');
            document.getElementById('hostSessionCode').textContent = currentSessionCode;
            
            setupHostListeners();
        }
        
        function setupHostListeners() {
            // Listen for join requests
            sessionListeners.joinRequests = database.ref(`sessions/${currentSessionCode}/joinRequests`).on('value', (snapshot) => {
                updateJoinRequests(snapshot.val() || {});
            });
            
            // Listen for participants
            sessionListeners.participants = database.ref(`sessions/${currentSessionCode}/participants`).on('value', (snapshot) => {
                updateParticipantsList(snapshot.val() || {});
            });
            
            // Listen for vote data
            sessionListeners.voteData = database.ref(`sessions/${currentSessionCode}/voteData`).on('value', (snapshot) => {
                updateLiveData(snapshot.val() || {});
            });
        }
        
        function updateJoinRequests(requests) {
            const joinRequestsList = document.getElementById('joinRequestsList');
            const requestsArray = Object.entries(requests);
            
            joinRequestsList.innerHTML = requestsArray.map(([id, request]) => `
                <div class="participant-request">
                    <span>${request.name} wants to join</span>
                    <div>
                        <button class="btn success" onclick="approveJoinRequest('${id}')">Approve</button>
                        <button class="btn danger" onclick="denyJoinRequest('${id}')">Deny</button>
                    </div>
                </div>
            `).join('');
        }
        
        function updateParticipantsList(participants) {
            const participantsList = document.getElementById('participantsList');
            const participantCount = document.getElementById('participantCount');
            const participantsArray = Object.entries(participants);
            
            participantCount.textContent = participantsArray.length;
            participantsList.innerHTML = participantsArray.map(([id, participant]) => `
                <div class="participant-request">
                    <span><div class="status-indicator status-connected"></div>${participant.name}</span>
                    <span>Current Box: ${participant.currentBox || 'Not Set'}</span>
                </div>
            `).join('');
        }
        
        function updateLiveData(voteData) {
            const liveData = document.getElementById('liveData');
            const boxNumbers = Object.keys(voteData).sort((a, b) => {
                const numA = parseInt(a) || 0;
                const numB = parseInt(b) || 0;
                return numA - numB;
            });
            
            if (boxNumbers.length === 0) {
                liveData.innerHTML = '<p style="text-align: center; color: #b3d9ff;">No vote data yet</p>';
                return;
            }
            
            liveData.innerHTML = boxNumbers.map(boxNumber => {
                const boxData = voteData[boxNumber];
                return `
                    <div class="box-summary">
                        <h4>Box ${boxNumber}${boxData.ward ? ` - ${boxData.ward}` : ''}</h4>
                        <div class="vote-tally">
                            ${sessionConfig.map(config => `
                                <div class="tally-item">
                                    <strong>${config.label}</strong><br>
                                    ${boxData.votes[config.party] || 0} votes
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function approveJoinRequest(requestId) {
            const requestRef = database.ref(`sessions/${currentSessionCode}/joinRequests/${requestId}`);
            
            requestRef.once('value').then((snapshot) => {
                const request = snapshot.val();
                if (request) {
                    // Create participant object
                    const participant = {
                        id: requestId,
                        name: request.name,
                        joinedAt: firebase.database.ServerValue.TIMESTAMP,
                        currentBox: null,
                        currentWard: null,
                        approved: true,
                        lastActivity: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    // First add to participants, then remove from requests
                    database.ref(`sessions/${currentSessionCode}/participants/${requestId}`).set(participant).then(() => {
                        // Wait a moment before removing from requests to ensure participant is added first
                        setTimeout(() => {
                            database.ref(`sessions/${currentSessionCode}/joinRequests/${requestId}`).remove();
                        }, 500);
                    }).catch((error) => {
                        console.error('Error approving participant:', error);
                        alert('Failed to approve participant. Please try again.');
                    });
                }
            }).catch((error) => {
                console.error('Error getting join request:', error);
            });
        }
        
        function denyJoinRequest(requestId) {
            // Remove from join requests - this will trigger the denial detection
            database.ref(`sessions/${currentSessionCode}/joinRequests/${requestId}`).remove().catch((error) => {
                console.error('Error denying join request:', error);
            });
        }
        
        function requestJoinSession() {
            const code = document.getElementById('sessionCode').value.trim();
            const name = document.getElementById('participantName').value.trim();
            
            if (!code || !name) {
                alert('Please enter both session code and your name');
                return;
            }
            
            // Check if session exists
            database.ref(`sessions/${code}`).once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    alert('Session not found. Please check the code.');
                    return;
                }
                
                // Generate unique participant ID with timestamp and random component
                const timestamp = Date.now();
                const random = Math.random().toString(36).substr(2, 9);
                const requestId = `participant_${timestamp}_${random}`;
                
                const joinRequest = {
                    id: requestId,
                    name: name,
                    requestedAt: firebase.database.ServerValue.TIMESTAMP
                };
                
                // Add join request
                database.ref(`sessions/${code}/joinRequests/${requestId}`).set(joinRequest).then(() => {
                    currentSessionCode = code;
                    currentParticipantName = name;
                    currentParticipantId = requestId;
                    currentUserRole = 'participant';
                    
                    document.getElementById('waitingMessage').classList.remove('hidden');
                    
                    // Listen for approval
                    checkApprovalStatus(requestId);
                }).catch((error) => {
                    console.error('Error sending join request:', error);
                    alert('Failed to send join request. Please try again.');
                });
            }).catch((error) => {
                console.error('Error checking session:', error);
                alert('Failed to join session. Please try again.');
            });
        }
        
        function checkApprovalStatus(requestId) {
            // Listen for approval (moved to participants)
            const participantRef = database.ref(`sessions/${currentSessionCode}/participants/${requestId}`);
            
            // Create a one-time listener for approval
            const approvalListener = participantRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    // Clean up listeners immediately
                    participantRef.off('value', approvalListener);
                    if (sessionListeners.denialListener) {
                        database.ref(`sessions/${currentSessionCode}/joinRequests/${requestId}`).off('value', sessionListeners.denialListener);
                    }
                    
                    console.log('User approved, showing participant screen');
                    
                    // Get session config and show participant screen
                    database.ref(`sessions/${currentSessionCode}/buttonConfig`).once('value').then((configSnapshot) => {
                        sessionConfig = configSnapshot.val();
                        showParticipantScreen();
                    }).catch((error) => {
                        console.error('Error getting session config:', error);
                        alert('Error loading session. Please try again.');
                    });
                }
            });
            
            // Set up a timeout to check for denial after a delay
            setTimeout(() => {
                // Check if we're still waiting and request was removed
                database.ref(`sessions/${currentSessionCode}/joinRequests/${requestId}`).once('value').then((requestSnapshot) => {
                    if (!requestSnapshot.exists()) {
                        // Request was removed, check if we were approved
                        database.ref(`sessions/${currentSessionCode}/participants/${requestId}`).once('value').then((participantSnapshot) => {
                            if (!participantSnapshot.exists()) {
                                // Not in participants either, so we were denied
                                participantRef.off('value', approvalListener);
                                console.log('User denied');
                                alert('Your join request was denied');
                                goHome();
                            }
                        });
                    }
                });
            }, 2000); // Check after 2 seconds
            
            // Store listener for cleanup
            sessionListeners.approvalListener = approvalListener;
        }
        
        function showParticipantScreen() {
            console.log('Showing participant screen for:', currentParticipantName);
            
            // Clean up any approval listeners
            if (sessionListeners.approvalListener) {
                database.ref(`sessions/${currentSessionCode}/participants/${currentParticipantId}`).off('value', sessionListeners.approvalListener);
                sessionListeners.approvalListener = null;
            }
            
            document.getElementById('joinSessionScreen').classList.add('hidden');
            document.getElementById('participantScreen').classList.remove('hidden');
            document.getElementById('participantSessionCode').textContent = currentSessionCode;
            document.getElementById('participantNameDisplay').textContent = currentParticipantName;
            
            // Generate party buttons based on host configuration
            if (sessionConfig && sessionConfig.length > 0) {
                const partyButtons = document.getElementById('partyButtons');
                partyButtons.innerHTML = sessionConfig.map((config, index) => `
                    <button class="party-btn ${config.party}" onclick="castVote('${config.party}')">
                        ${config.label}
                        <div class="count" id="count_${config.party}">0</div>
                    </button>
                `).join('');
            } else {
                console.error('No session config available');
                alert('Error loading session configuration. Please try rejoining.');
                goHome();
                return;
            }
            
            updateCurrentBoxDisplay();
            setupParticipantListeners();
        }
        
        function setupParticipantListeners() {
            // Listen for session end
            if (sessionListeners.sessionEnd) {
                database.ref(`sessions/${currentSessionCode}`).off('value', sessionListeners.sessionEnd);
            }
            
            sessionListeners.sessionEnd = database.ref(`sessions/${currentSessionCode}`).on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    alert('Session has ended');
                    goHome();
                }
            });
            
            // Listen for vote data updates for current box
            if (currentBox) {
                setupVoteListener();
            }
        }
        
        function setupVoteListener() {
            if (!currentBox) return;
            
            // Clean up existing vote listener
            if (sessionListeners.voteListener) {
                database.ref(`sessions/${currentSessionCode}/voteData/${sessionListeners.currentListenBox}/votes`).off('value', sessionListeners.voteListener);
            }
            
            // Set up new listener for current box
            sessionListeners.currentListenBox = currentBox;
            sessionListeners.voteListener = database.ref(`sessions/${currentSessionCode}/voteData/${currentBox}/votes`).on('value', (snapshot) => {
                const votes = snapshot.val() || {};
                
                sessionConfig.forEach(config => {
                    const countElement = document.getElementById(`count_${config.party}`);
                    if (countElement) {
                        countElement.textContent = votes[config.party] || 0;
                    }
                });
            });
        }
        
        function setCurrentBox() {
            const boxNumber = document.getElementById('boxNumber').value.trim();
            const ward = document.getElementById('ward').value.trim();
            
            if (!boxNumber) {
                alert('Box number is required');
                return;
            }
            
            currentBox = boxNumber;
            currentWard = ward;
            
            // Update participant info in Firebase
            const updates = {};
            updates[`sessions/${currentSessionCode}/participants/${currentParticipantId}/currentBox`] = currentBox;
            updates[`sessions/${currentSessionCode}/participants/${currentParticipantId}/currentWard`] = currentWard;
            updates[`sessions/${currentSessionCode}/participants/${currentParticipantId}/lastActivity`] = firebase.database.ServerValue.TIMESTAMP;
            
            database.ref().update(updates);
            
            // Initialize vote data for this box if it doesn't exist
            database.ref(`sessions/${currentSessionCode}/voteData/${currentBox}`).once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    const boxData = {
                        ward: currentWard,
                        votes: {},
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    };
                    database.ref(`sessions/${currentSessionCode}/voteData/${currentBox}`).set(boxData);
                }
            });
            
            updateCurrentBoxDisplay();
            setupVoteListener(); // Set up real-time vote count listener
        }
        
        function updateCurrentBoxDisplay() {
            document.getElementById('currentBoxDisplay').textContent = currentBox || 'Not Set';
            document.getElementById('currentWardDisplay').textContent = currentWard || 'Not Set';
        }
        
        function castVote(party) {
            if (!currentBox) {
                alert('Please set a box number first');
                return;
            }
            
            const voteRef = database.ref(`sessions/${currentSessionCode}/voteData/${currentBox}/votes/${party}`);
            const activityRef = database.ref(`sessions/${currentSessionCode}/participants/${currentParticipantId}/lastActivity`);
            
            // Increment vote count and update activity timestamp
            voteRef.transaction((currentCount) => {
                return (currentCount || 0) + 1;
            }).then(() => {
                // Update last activity
                activityRef.set(firebase.database.ServerValue.TIMESTAMP);
                
                // Visual feedback
                const button = document.querySelector(`.party-btn.${party}`);
                if (button) {
                    button.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        button.style.transform = '';
                    }, 150);
                }
            }).catch((error) => {
                console.error('Error casting vote:', error);
                alert('Failed to cast vote. Please try again.');
            });
        }
        
        function updateVoteCounts() {
            if (!currentBox) return;
            
            database.ref(`sessions/${currentSessionCode}/voteData/${currentBox}/votes`).once('value').then((snapshot) => {
                const votes = snapshot.val() || {};
                
                if (sessionConfig) {
                    sessionConfig.forEach(config => {
                        const countElement = document.getElementById(`count_${config.party}`);
                        if (countElement) {
                            countElement.textContent = votes[config.party] || 0;
                        }
                    });
                }
            }).catch((error) => {
                console.error('Error updating vote counts:', error);
            });
        }
        
        function nextBox() {
            // Clean up current box vote listener
            if (sessionListeners.voteListener && sessionListeners.currentListenBox) {
                database.ref(`sessions/${currentSessionCode}/voteData/${sessionListeners.currentListenBox}/votes`).off('value', sessionListeners.voteListener);
                sessionListeners.voteListener = null;
                sessionListeners.currentListenBox = null;
            }
            
            // Clear current box info
            currentBox = null;
            currentWard = null;
            
            document.getElementById('boxNumber').value = '';
            document.getElementById('ward').value = '';
            
            // Reset vote counts display
            if (sessionConfig) {
                sessionConfig.forEach(config => {
                    const countElement = document.getElementById(`count_${config.party}`);
                    if (countElement) {
                        countElement.textContent = '0';
                    }
                });
            }
            
            // Update participant info in Firebase
            const updates = {};
            updates[`sessions/${currentSessionCode}/participants/${currentParticipantId}/currentBox`] = null;
            updates[`sessions/${currentSessionCode}/participants/${currentParticipantId}/currentWard`] = null;
            updates[`sessions/${currentSessionCode}/participants/${currentParticipantId}/lastActivity`] = firebase.database.ServerValue.TIMESTAMP;
            
            database.ref().update(updates);
            
            updateCurrentBoxDisplay();
        }
        
        function downloadData() {
            database.ref(`sessions/${currentSessionCode}/voteData`).once('value').then((snapshot) => {
                const voteData = snapshot.val();
                
                if (!voteData || Object.keys(voteData).length === 0) {
                    alert('No data to download');
                    return;
                }
                
                // Create CSV content
                let csvContent = "Box Number,Ward,";
                
                // Add party headers
                sessionConfig.forEach(config => {
                    csvContent += `${config.label.replace(/,/g, ';')},`;
                });
                csvContent += "Total Votes\n";
                
                // Sort box numbers numerically
                const boxNumbers = Object.keys(voteData).sort((a, b) => {
                    const numA = parseInt(a) || 0;
                    const numB = parseInt(b) || 0;
                    return numA - numB;
                });
                
                // Add data rows
                boxNumbers.forEach(boxNumber => {
                    const boxData = voteData[boxNumber];
                    let row = `"${boxNumber}","${boxData.ward || ''}",`;
                    
                    let totalVotes = 0;
                    sessionConfig.forEach(config => {
                        const votes = boxData.votes[config.party] || 0;
                        row += `${votes},`;
                        totalVotes += votes;
                    });
                    
                    row += `${totalVotes}\n`;
                    csvContent += row;
                });
                
                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                const timestamp = new Date().toISOString().split('T')[0];
                
                link.setAttribute("href", url);
                link.setAttribute("download", `votecount_session_${currentSessionCode}_${timestamp}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
            });
        }
        
        function endSession() {
            if (confirm('Are you sure you want to end this session? All participants will be disconnected and data will be deleted.')) {
                // Download data first
                downloadData();
                
                // Remove session from Firebase after a delay to allow download
                setTimeout(() => {
                    database.ref(`sessions/${currentSessionCode}`).remove().then(() => {
                        cleanupListeners();
                        goHome();
                    });
                }, 1000);
            }
        }
        
        function leaveSession() {
            if (confirm('Are you sure you want to leave this session?')) {
                // Remove participant from session
                if (currentParticipantId) {
                    database.ref(`sessions/${currentSessionCode}/participants/${currentParticipantId}`).remove();
                }
                
                cleanupListeners();
                goHome();
            }
        }
        
        function cleanupListeners() {
            console.log('Cleaning up listeners for user:', currentParticipantName);
            
            // Remove all Firebase listeners with proper cleanup
            if (sessionListeners.joinRequests) {
                database.ref(`sessions/${currentSessionCode}/joinRequests`).off('value', sessionListeners.joinRequests);
                sessionListeners.joinRequests = null;
            }
            if (sessionListeners.participants) {
                database.ref(`sessions/${currentSessionCode}/participants`).off('value', sessionListeners.participants);
                sessionListeners.participants = null;
            }
            if (sessionListeners.voteData) {
                database.ref(`sessions/${currentSessionCode}/voteData`).off('value', sessionListeners.voteData);
                sessionListeners.voteData = null;
            }
            if (sessionListeners.sessionEnd) {
                database.ref(`sessions/${currentSessionCode}`).off('value', sessionListeners.sessionEnd);
                sessionListeners.sessionEnd = null;
            }
            if (sessionListeners.voteListener && sessionListeners.currentListenBox) {
                database.ref(`sessions/${currentSessionCode}/voteData/${sessionListeners.currentListenBox}/votes`).off('value', sessionListeners.voteListener);
                sessionListeners.voteListener = null;
                sessionListeners.currentListenBox = null;
            }
            if (sessionListeners.approvalListener && currentParticipantId) {
                database.ref(`sessions/${currentSessionCode}/participants/${currentParticipantId}`).off('value', sessionListeners.approvalListener);
                sessionListeners.approvalListener = null;
            }
            if (sessionListeners.denialListener && currentParticipantId) {
                database.ref(`sessions/${currentSessionCode}/joinRequests/${currentParticipantId}`).off('value', sessionListeners.denialListener);
                sessionListeners.denialListener = null;
            }
            
            // Clear all listeners
            sessionListeners = {};
        }
        
        function goHome() {
            cleanupListeners();
            
            // Reset all global variables
            currentSessionCode = null;
            currentUserRole = null;
            currentParticipantName = null;
            currentParticipantId = null;
            currentBox = null;
            currentWard = null;
            sessionConfig = null;
            
            // Hide all screens except home
            document.querySelectorAll('.container').forEach(container => {
                container.classList.add('hidden');
            });
            
            if (isFirebaseInitialized) {
                document.getElementById('homeScreen').classList.remove('hidden');
            } else {
                document.getElementById('firebaseSetup').classList.remove('hidden');
            }
            
            // Reset forms
            document.getElementById('sessionCode').value = '';
            document.getElementById('participantName').value = '';
            document.getElementById('boxNumber').value = '';
            document.getElementById('ward').value = '';
            document.getElementById('waitingMessage').classList.add('hidden');
            
            // Reset button configuration to defaults
            document.getElementById('button1Select').value = 'conservative';
            document.getElementById('button2Select').value = 'labour';
            document.getElementById('button3Select').value = 'reform';
            document.getElementById('button4Select').value = 'libdem';
            
            document.getElementById('button1Note').value = '';
            document.getElementById('button2Note').value = '';
            document.getElementById('button3Note').value = '';
            document.getElementById('button4Note').value = '';
        }
        
        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (currentUserRole === 'participant' && currentParticipantId) {
                // Remove participant from session
                database.ref(`sessions/${currentSessionCode}/participants/${currentParticipantId}`).remove();
            }
            cleanupListeners();
        });
        
        // Initialize the app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Check if Firebase config has been updated
            if (firebaseConfig.apiKey !== "placeholder-api-key") {
                initializeFirebase();
            }
        });
        
        // Auto-initialize if config is already set
        if (firebaseConfig.apiKey !== "placeholder-api-key") {
            initializeFirebase();
        }
    </script>
</body>
</html>
